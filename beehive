#!/bin/bash
# beehive - Multi-agent orchestration for Claude Code
#
# Usage:
#   beehive [path]           Run agents (auto-detects mode)
#   beehive --init [path]    Initialize repo/workspace structure
#
# The tool auto-detects:
#   - Workspace mode: if path contains WORKSPACE.md or multiple git repos
#   - Single repo mode: if path is a single repository
#
# Unlike Gas Town's autonomous GUPP model, this uses an interactive model
# where the user directs agents and copies messages between them.

set -e

VERSION="0.2.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# DEFAULT_SESSION is set dynamically from folder name
CONFIG_FILE=".beehive.conf"

#######################################
# Helpers
#######################################
die() { echo -e "${RED}ERROR: $1${NC}" >&2; exit 1; }
warn() { echo -e "${YELLOW}WARNING: $1${NC}" >&2; }
info() { echo -e "${CYAN}$1${NC}"; }
success() { echo -e "${GREEN}$1${NC}"; }

#######################################
# Parse config file safely (no source)
#######################################
load_config() {
    local config_path="$1/$CONFIG_FILE"
    [[ ! -f "$config_path" ]] && return 1

    info "Loading config from $config_path"
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue

        # Remove leading/trailing whitespace and quotes
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs | sed 's/^["'"'"']//;s/["'"'"']$//')

        # Only allow known config keys
        case "$key" in
            CONF_AWS_PROFILE)  AWS_PROFILE="$value" ;;
            CONF_AWS_REGION)   AWS_REGION="$value" ;;
            CONF_MODEL)        ANTHROPIC_MODEL="$value" ;;
            CONF_SESSION)      SESSION_NAME="$value" ;;
            CONF_CLAUDE_CMD)   CLAUDE="$value" ;;
        esac
    done < "$config_path"
    return 0
}

#######################################
# Detect clipboard for current OS
#######################################
detect_clipboard() {
    if command -v pbcopy &> /dev/null; then
        echo "pbcopy"
    elif command -v xclip &> /dev/null; then
        echo "xclip -selection clipboard"
    elif command -v xsel &> /dev/null; then
        echo "xsel --clipboard --input"
    else
        echo "cat > /dev/null"
    fi
}

#######################################
# Find claude command
#######################################
find_claude() {
    [[ -n "$CLAUDE" ]] && command -v "$CLAUDE" &> /dev/null && echo "$CLAUDE" && return 0

    for loc in claude /opt/homebrew/bin/claude /usr/local/bin/claude "$HOME/.local/bin/claude"; do
        command -v "$loc" &> /dev/null && echo "$loc" && return 0
    done
    return 1
}

#######################################
# Detect if path is workspace or repo
#######################################
detect_mode() {
    local path="$1"

    # Explicit workspace marker
    [[ -f "$path/WORKSPACE.md" ]] && echo "workspace" && return

    # Count git repos in directory
    local git_count=0
    for dir in "$path"/*/; do
        [[ -d "$dir/.git" ]] && ((git_count++))
    done

    # Multiple git repos = workspace, otherwise single repo
    [[ $git_count -gt 1 ]] && echo "workspace" || echo "repo"
}

#######################################
# Initialize structure
#######################################
do_init() {
    local path="$1"
    local mode
    mode=$(detect_mode "$path")

    echo ""
    if [[ "$mode" == "workspace" ]]; then
        info "Initializing workspace in: $path"
        init_workspace "$path"
    else
        info "Initializing repository in: $path"
        init_repo "$path"
    fi
}

init_skills() {
    local dir="$1"
    mkdir -p "$dir/.skills"

    [[ ! -f "$dir/.skills/bee.md" ]] && cp "$SCRIPT_DIR/skills/bee.md" "$dir/.skills/bee.md"
    [[ ! -f "$dir/.skills/queen.md" ]] && cp "$SCRIPT_DIR/skills/queen.md" "$dir/.skills/queen.md"
}

init_hive() {
    local dir="$1"
    mkdir -p "$dir/.hive"

    for i in 1 2 3; do
        if [[ ! -f "$dir/.hive/bee-$i.md" ]]; then
            sed "s/Bee N/Bee $i/g" "$SCRIPT_DIR/templates/bee-status.md" > "$dir/.hive/bee-$i.md"
        fi
    done
}

init_inbox() {
    local dir="$1"
    [[ ! -f "$dir/plans/INBOX.md" ]] && cp "$SCRIPT_DIR/templates/INBOX.md" "$dir/plans/INBOX.md"
}

init_commands() {
    local dir="$1"
    mkdir -p "$dir/.claude/commands"

    for cmd in report sting buzz bedtime; do
        [[ ! -f "$dir/.claude/commands/$cmd.md" ]] && cp "$SCRIPT_DIR/commands/$cmd.md" "$dir/.claude/commands/$cmd.md"
    done
}

init_gitignore() {
    local dir="$1"
    local gitignore="$dir/.gitignore"

    # If .gitignore doesn't exist, create from template
    if [[ ! -f "$gitignore" ]]; then
        cp "$SCRIPT_DIR/templates/gitignore" "$gitignore"
        return
    fi

    # If .gitignore exists, ensure .hive/ is in it
    if ! grep -q "^\.hive/" "$gitignore" 2>/dev/null; then
        echo "" >> "$gitignore"
        echo "# Beehive status files" >> "$gitignore"
        echo ".hive/" >> "$gitignore"
    fi
}

init_template() {
    local dir="$1"

    [[ ! -f "$dir/plans/TEMPLATE.md" ]] && cp "$SCRIPT_DIR/templates/plan.md" "$dir/plans/TEMPLATE.md"
}

init_repo() {
    local dir="$1"
    mkdir -p "$dir/plans/completed"

    [[ ! -f "$dir/CLAUDE.md" ]] && cat > "$dir/CLAUDE.md" << 'EOF'
# Project Instructions for Claude

## Overview
<!-- Describe the project -->

## Agent Roles
- **Queen (ğŸ)**: Creates plans, tracks progress, verifies completion. Read `.skills/queen.md`
- **Bees (ğŸ)**: Execute plans, update status, report discoveries. Read `.skills/bee.md`

## Coordination Files
- `plans/TRACKER.md` - Plan status (Queen owns)
- `.hive/bee-N.md` - Bee status files (each Bee owns their own)
- `plans/INBOX.md` - Plan requests from Bees

## Guidelines
- Ask approval before environment-impacting operations
- Bees report completion to Queen for verification
- Use /report, /sting, /buzz commands
EOF

    [[ ! -f "$dir/plans/TRACKER.md" ]] && cat > "$dir/plans/TRACKER.md" << 'EOF'
# Plan Tracker

**Points Scale:** 1 = Small, 2 = Medium, 3 = Large

## Active Plans
| Plan | Pts | Priority | Status | Assigned |
|------|-----|----------|--------|----------|

## Completed
| Plan | Pts | Outcome |
|------|-----|---------|
EOF

    init_skills "$dir"
    init_hive "$dir"
    init_inbox "$dir"
    init_commands "$dir"
    init_template "$dir"
    init_gitignore "$dir"

    success "âœ“ Initialized: $dir"
    echo "  Run: beehive $dir"
}

init_workspace() {
    local dir="$1"
    mkdir -p "$dir/plans/completed"

    [[ ! -f "$dir/CLAUDE.md" ]] && cat > "$dir/CLAUDE.md" << 'EOF'
# Workspace Instructions

Multi-repo workspace. Read WORKSPACE.md for repo overview, TRACKER.md for active plans.
When assigned a plan, cd to the target repo and read its CLAUDE.md.

## Agent Roles
- **Queen (ğŸ)**: Creates plans, tracks progress, verifies completion. Read `.skills/queen.md`
- **Bees (ğŸ)**: Execute plans, update status, report discoveries. Read `.skills/bee.md`

## Coordination Files
- `TRACKER.md` - Plan status (Queen owns)
- `.hive/bee-N.md` - Bee status files (each Bee owns their own)
- `plans/INBOX.md` - Plan requests from Bees

## Guidelines
- Ask approval before environment-impacting operations
- Bees report completion to Queen for verification
- Use /report, /sting, /buzz commands
EOF

    [[ ! -f "$dir/WORKSPACE.md" ]] && {
        {
            echo "# Workspace Overview"
            echo ""
            echo "## Repositories"
            echo "| Repository | Description | Status |"
            echo "|------------|-------------|--------|"
            for repo in "$dir"/*/; do
                [[ -d "$repo/.git" ]] && echo "| $(basename "$repo") | - | - |"
            done
        } > "$dir/WORKSPACE.md"
    }

    [[ ! -f "$dir/TRACKER.md" ]] && cat > "$dir/TRACKER.md" << 'EOF'
# Workspace Tracker

**Points Scale:** 1 = Small, 2 = Medium, 3 = Large

## Active Plans
| Plan | Pts | Repository | Priority | Status | Assigned |
|------|-----|------------|----------|--------|----------|

## Completed
| Plan | Pts | Repository | Outcome |
|------|-----|------------|---------|
EOF

    # Add CLAUDE.md to repos that don't have one
    for repo in "$dir"/*/; do
        [[ -d "$repo/.git" && ! -f "$repo/CLAUDE.md" ]] && {
            {
                echo "# $(basename "$repo")"
                echo ""
                echo "## Overview"
                echo "<!-- Describe this repo -->"
            } > "$repo/CLAUDE.md"
        }
    done

    init_skills "$dir"
    init_hive "$dir"
    init_inbox "$dir"
    init_commands "$dir"
    init_template "$dir"
    init_gitignore "$dir"

    success "âœ“ Initialized workspace: $dir"
    echo "  Run: beehive $dir"
}

#######################################
# Launch agents
#######################################
do_launch() {
    local path="$1"
    local mode
    mode=$(detect_mode "$path")

    # Config already loaded before confirmation

    # Find claude
    CLAUDE=$(find_claude) || die "Claude CLI not found. Install from: https://claude.ai/claude-code"

    # Session name
    SESSION_NAME="${SESSION_NAME:-$(basename "$path")}"

    # Check requirements
    command -v tmux &> /dev/null || die "tmux required. Install: brew install tmux"

    if [[ "$mode" == "workspace" ]]; then
        [[ ! -f "$path/WORKSPACE.md" ]] && die "Not initialized. Run: beehive --init $path"
    else
        [[ ! -f "$path/CLAUDE.md" ]] && die "Not initialized. Run: beehive --init $path"
    fi

    # Build env vars and model flag
    local env_vars=""
    local model_flag=""
    [[ -n "$AWS_PROFILE" ]] && env_vars+="AWS_PROFILE=$AWS_PROFILE "
    [[ -n "$AWS_REGION" ]] && env_vars+="AWS_REGION=$AWS_REGION "
    [[ -n "$ANTHROPIC_MODEL" ]] && model_flag="--model $ANTHROPIC_MODEL"

    # Kill existing
    tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true

    # Create session
    local clip
    clip=$(detect_clipboard)

    tmux new-session -d -s "$SESSION_NAME" -c "$path" -x 200 -y 50
    tmux split-window -h -t "$SESSION_NAME:0.0" -c "$path"
    tmux split-window -v -t "$SESSION_NAME:0.0" -c "$path"
    tmux split-window -v -t "$SESSION_NAME:0.1" -c "$path"
    tmux select-layout -t "$SESSION_NAME" tiled

    tmux set-option -t "$SESSION_NAME" pane-border-status top
    tmux set-option -t "$SESSION_NAME" pane-border-format " #T "
    tmux set-option -t "$SESSION_NAME" mouse on
    tmux set-option -t "$SESSION_NAME" -g set-clipboard on
    tmux bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "$clip"
    tmux bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "$clip"

    tmux select-pane -t "$SESSION_NAME:0.0" -T "ğŸ Bee 1"
    tmux select-pane -t "$SESSION_NAME:0.1" -T "ğŸ Bee 2"
    tmux select-pane -t "$SESSION_NAME:0.2" -T "ğŸ Bee 3"
    tmux select-pane -t "$SESSION_NAME:0.3" -T "ğŸ Queen"

    # Prompts - agents read their skill files
    local tracker="TRACKER.md"
    [[ "$mode" == "repo" ]] && tracker="plans/TRACKER.md"

    local bee_prompt="Read CLAUDE.md, .skills/bee.md"
    [[ "$mode" == "workspace" ]] && bee_prompt+=", WORKSPACE.md"
    bee_prompt+=", then $tracker and .hive/bee-%d.md. You are Bee %d. Follow your skill instructions. Update your status file. Use /report for discoveries, /sting to self-check, /bedtime to save state. Wait for user direction."

    local queen_prompt="Read CLAUDE.md, .skills/queen.md"
    [[ "$mode" == "workspace" ]] && queen_prompt+=", WORKSPACE.md"
    queen_prompt+=", then $tracker. You are the Queen. Follow your skill instructions. Use /buzz to consolidate status. Wait for user direction."

    # Launch
    for i in 0 1 2; do
        local prompt
        local bee_num=$((i + 1))
        # shellcheck disable=SC2059
        printf -v prompt "$bee_prompt" "$bee_num" "$bee_num"
        tmux send-keys -t "$SESSION_NAME:0.$i" "${env_vars}${CLAUDE} ${model_flag} '$prompt'" Enter
        sleep 1
    done
    tmux send-keys -t "$SESSION_NAME:0.3" "${env_vars}${CLAUDE} ${model_flag} '$queen_prompt'" Enter
    tmux select-pane -t "$SESSION_NAME:0.3"

    echo ""
    success "âœ“ Launched 4 agents"
    echo ""
    echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "  â”‚ ğŸ Bee 1 â”‚ ğŸ Bee 2 â”‚"
    echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "  â”‚ ğŸ Bee 3 â”‚ ğŸ Queen â”‚"
    echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
    echo "  Ctrl+B, D  Detach (keeps running)"
    echo "  Ctrl+B, z  Zoom pane"
    echo ""

    sleep 1
    tmux attach-session -t "$SESSION_NAME"
}

#######################################
# Usage
#######################################
usage() {
    cat << EOF
Usage: beehive [options] [path]

Orchestrate multiple Claude Code agents in tmux.

Commands:
    beehive [path]        Launch agents (default: current directory)
    beehive --init [path] Initialize repo/workspace structure

Options:
    --session NAME    Session name (default: folder name)
    --model MODEL     Anthropic model override
    --profile PROF    AWS profile for Bedrock
    --region REGION   AWS region for Bedrock
    --yes             Skip confirmation
    --version         Show version
    --help            Show this help

Examples:
    beehive                      # Run in current directory
    beehive ~/myproject          # Run in specific path
    beehive --init ~/projects    # Initialize (auto-detects workspace vs repo)

EOF
    exit 0
}

#######################################
# Main
#######################################
main() {
    local cmd=""
    local path=""
    local skip_confirm=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --init)      cmd="init"; shift ;;
            --session)   SESSION_NAME="$2"; shift 2 ;;
            --model)     ANTHROPIC_MODEL="$2"; shift 2 ;;
            --profile)   AWS_PROFILE="$2"; shift 2 ;;
            --region)    AWS_REGION="$2"; shift 2 ;;
            --yes|-y)    skip_confirm=true; shift ;;
            --version)   echo "beehive v$VERSION"; exit 0 ;;
            --help|-h)   usage ;;
            -*)          die "Unknown option: $1" ;;
            *)           path="$1"; shift ;;
        esac
    done

    path="${path:-$(pwd)}"
    [[ ! -d "$path" ]] && die "Directory not found: $path"

    case "$cmd" in
        init) do_init "$path" ;;
        *)
            echo ""
            echo -e "${GREEN}Beehive${NC} v$VERSION"
            echo ""

            local mode
            mode=$(detect_mode "$path")

            # Load config early to show settings
            load_config "$path" || true

            if [[ "$mode" == "workspace" ]]; then
                info "Mode: Workspace"
            else
                info "Mode: Single repo"
            fi
            info "Path: $path"
            [[ -n "$ANTHROPIC_MODEL" ]] && info "Model: $ANTHROPIC_MODEL"
            [[ -n "$AWS_PROFILE" ]] && info "AWS Profile: $AWS_PROFILE"
            [[ -n "$AWS_REGION" ]] && info "AWS Region: $AWS_REGION"
            echo ""

            if ! $skip_confirm; then
                read -p "Launch 4 agents? [Y/n] " -n 1 -r
                echo ""
                [[ $REPLY =~ ^[Nn]$ ]] && { echo "Aborted."; exit 0; }
            fi

            do_launch "$path"
            ;;
    esac
}

main "$@"
